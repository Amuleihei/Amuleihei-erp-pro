<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.skyeye.dao.UserPhoneDao">

	<select id="queryMationByUserCode" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.id,
			a.user_code userCode,
			a.pwd_num_enc pwdNum,
			a.`password`,
			a.user_lock userLock,
			c.user_name userName,
			c.user_photo userPhoto,
			c.user_sign userSign,
			c.department_id departmentId,
			c.job_id jobId,
		    a.role_id roleId
		FROM
			sys_eve_user a
			LEFT JOIN sys_eve_user_install b ON a.id = b.user_id
			LEFT JOIN sys_eve_user_staff c ON a.id = c.user_id
		WHERE
			a.user_code = #{userCode}
	</select>
	
	<select id="queryWxUserMationByOpenId" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT
			a.id,
			a.open_id openId,
			a.user_id userId,
			a.join_time joinTime
		FROM
			wx_user_mation a
		WHERE
			a.open_id = #{openId}
		LIMIT 1
	</select>
	
	<insert id="insertWxUserMation" parameterType="java.util.Map">
	     INSERT into wx_user_mation 
	     (id, open_id, join_time)
	     VALUES
	     (#{id}, #{openId}, #{joinTime})
	</insert>

	<select id="queryUserBindMationByUserId" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT
			a.id
		FROM
			wx_user_mation a
		WHERE
			a.user_id = #{userId}
		LIMIT 1
	</select>
	
	<update id="updateBindUserMation" parameterType="java.util.Map">
		UPDATE wx_user_mation
		<set>
			<if test="userId != '' and userId != null">
				user_id = #{userId},
			</if>
			<if test="bindTime != '' and bindTime != null">
				binding_time = #{bindTime},
			</if>
		</set>
		WHERE open_id = #{openId}
	</update>
	
	<select id="queryUserMationByOpenId" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT
			a.id,
			a.user_code userCode,
			a.pwd_num_enc pwdNum,
			a.`password`,
			a.user_lock userLock,
			b.win_bg_pic_url winBgPicUrl,
			b.win_lock_bg_pic_url winLockBgPicUrl,
			b.win_theme_color winThemeColor,
			b.win_start_menu_size winStartMenuSize,
			b.win_task_position winTaskPosition,
			b.win_bg_pic_vague winBgPicVague,
			b.win_bg_pic_vague_value winBgPicVagueValue,
			b.win_bottom_menu_icon loadBottomMenuIcon,
			c.user_name userName,
			c.user_photo userPhoto,
			c.company_id companyId,
			c.department_id departmentId
		FROM
			sys_eve_user a
			LEFT JOIN sys_eve_user_install b ON a.id = b.user_id
			LEFT JOIN sys_eve_user_staff c ON a.id = c.user_id,
			wx_user_mation e
		WHERE
			e.open_id = #{openId}
		AND a.id = e.user_id
	</select>
	
	<select id="queryAllPeopleToTree" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			a.user_id id,
			CONCAT_WS('_', a.job_number, a.user_name) `name`,
			a.job_id pId,
			'isPeople' folderType,
			0 isParent,
			'../../assets/images/people-icon.png' `icon`,
			a.email `email`
		FROM
			sys_eve_user_staff a
		WHERE a.state = '1'
		AND LENGTH(a.user_id) > 0 AND a.user_id != ''
		<if test="userId != null and userId != ''">
			AND a.user_id != #{userId}
		</if>
		<if test="hasEmail != null and hasEmail != ''">
			AND LENGTH(a.email) > 0 AND a.email != ''
		</if>
	</select>

</mapper>